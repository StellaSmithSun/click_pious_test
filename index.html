<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PiousClick</title>

<!-- 引入 Phaser 3 -->
<script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js" defer></script>

<style>
  body { margin: 0; padding: 0; background: #222; }
</style>
</head>
<body>

<script defer>
window.onload = function() {
    
    const userId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id;

    
    if (window.Telegram?.WebApp?.initDataUnsafe?.user?.id) {
        userId = window.Telegram.WebApp.initDataUnsafe.user.id;
        alert("Telegram User ID:", userId);
    } else {
        alert("非 Telegram 环境，仅本地游戏模式");
    if (!userId) {
        console.warn("不是在 Telegram 内打开，无法记录用户点击 ID");
        // 这里可以选择： 
        // 1. 允许游戏加载（本地计数仍然可以）
        // 2. 或者显示提示，但不要阻止 Phaser 初始化
    }



    let count = parseInt(localStorage.getItem("count") || "0");



// window.onload = function() {
//     // 从 localStorage 读取点击次数，如果没有就初始化为 0
    // let count = parseInt(localStorage.getItem("count") || "0");

//     // 预加载资源
    function preload() {
        this.load.image("muyu", "assets/muyu.png"); // 木鱼图片
    }

    // 创建场景
    function create() {
        const centerX = this.cameras.main.centerX;
        const centerY = this.cameras.main.centerY;

        // 添加木鱼图片
        const muyu = this.add.image(centerX, centerY, "muyu")
            .setScale(0.4)        // 缩放
            .setInteractive();    // 可以点击

        // 添加计数文字
        const text = this.add.text(centerX, 80, "Count: " + count, {
            fontSize: "32px",
            color: "#ffffff"
        }).setOrigin(0.5);

        // 点击木鱼事件
        muyu.on("pointerdown", () => {
            count++; // 点击计数
            localStorage.setItem("count", count); // 存到浏览器
            text.setText("Count: " + count); // 更新显示
            //点击后发送signal
            onClicked();

            // 木鱼点击缩放动画
            this.tweens.add({
                targets: muyu,
                scale: 0.37,
                yoyo: true,
                duration: 100
            });
        });
    }

    // 游戏配置
    const config = {
        type: Phaser.AUTO,
        width: 400,
        height: 600,
        backgroundColor: "#222222",
        scene: {
            preload: preload,
            create: create
        }
    };

    //点击后发送signal
    function onClicked() {
        fetch("https://glady-nongelling-mila.ngrok-free.dev/click", {
            method: "POST",headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                user_id: userId
                })
  });
}

    // 创建 Phaser 游戏实例
    const game = new Phaser.Game(config);
};
</script>

</body>
</html>
