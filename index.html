<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PiousClick</title>

<script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js"></script>

<style>
  body { margin: 0; padding: 0; background: #222; }
</style>
</head>
<body>

<script>
    // æ•´ä¸ªè„šæœ¬ç›´æ¥åœ¨å…¨å±€ä½œç”¨åŸŸå†…æ‰§è¡Œ
    let userId = null; // åˆå§‹åŒ–ä¸º null
    let count = parseInt(localStorage.getItem("count") || "0"); // ä» localStorage è¯»å–è®¡æ•°

    // --- 1. Phaser æ¸¸æˆæ ¸å¿ƒå‡½æ•° ---

    function preload() {
        // â—â— å»ºè®®ä½¿ç”¨ç»å¯¹è·¯å¾„ â—â—
        // è¯·æ›¿æ¢æˆæ‚¨å®é™…çš„ GitHub Pages è·¯å¾„ï¼Œä¾‹å¦‚:
        // this.load.image("muyu", "https://stellasmithsun.github.io/click_pious_test/assets/muyu.png"); 
        this.load.image("muyu", "assets/muyu.png"); 
    }

    function create() {
        const centerX = this.cameras.main.centerX;
        const centerY = this.cameras.main.centerY;

        const muyu = this.add.image(centerX, centerY, "muyu")
            .setScale(0.4)
            .setInteractive();

        const text = this.add.text(centerX, 80, "Count: " + count, {
            fontSize: "32px",
            color: "#ffffff"
        }).setOrigin(0.5);

        muyu.on("pointerdown", () => {
            count++;
            localStorage.setItem("count", count);
            text.setText("Count: " + count);
            onClicked();

            this.tweens.add({
                targets: muyu,
                scale: 0.37,
                yoyo: true,
                duration: 100
            });
        });
    }

    const config = {
        type: Phaser.AUTO,
        width: 400,
        height: 600,
        backgroundColor: "#222222",
        scene: {
            preload: preload,
            create: create
        }
    };

    function onClicked() {
        console.log(`å‘é€ç‚¹å‡»ä¿¡å·ï¼ŒUser ID: ${userId || 'N/A'}`);
        fetch("https://glady-nongelling-mila.ngrok-free.dev/click", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                user_id: userId
            })
        }).catch(e => {
            console.error("å‘é€ç‚¹å‡»ä¿¡å·å¤±è´¥:", e);
        });
    }

    // --- 2. TWA å¥å£®åˆå§‹åŒ–å’Œæ¸¸æˆå¯åŠ¨é€»è¾‘ ---

    function startGame() {
        console.log("ğŸ® å¯åŠ¨ Phaser æ¸¸æˆ...");
        new Phaser.Game(config);
    }
    
    let isWebAppReady = false; 
    const timeoutDuration = 1500; 
    
    // è®¾ç½®è¶…æ—¶ï¼Œé˜²æ­¢ TWA åˆå§‹åŒ–å¡ä½æ¸¸æˆå¯åŠ¨
    const timeoutId = setTimeout(() => {
        if (!isWebAppReady) {
            console.warn("âš ï¸ Telegram WebApp æ¥å£è¶…æ—¶ (1.5s)ï¼Œä»¥æœ¬åœ°æ¨¡å¼å¯åŠ¨ã€‚");
            startGame();
        }
    }, timeoutDuration);

    if (window.Telegram && window.Telegram.WebApp) {
        console.log("â³ æ£€æµ‹åˆ° TWA å¯¹è±¡ï¼Œç­‰å¾… ready äº‹ä»¶...");
        window.Telegram.WebApp.ready(() => {
            clearTimeout(timeoutId); 
            isWebAppReady = true;

            // å®‰å…¨åœ°è·å– userId
            userId = window.Telegram.WebApp.initDataUnsafe?.user?.id || null;
            
            if (userId) {
                console.log(`âœ… Telegram User ID è·å–æˆåŠŸ: ${userId}`);
            } else {
                console.warn("âš ï¸ TWA ç¯å¢ƒä¸‹æ— æ³•è·å– User IDï¼Œä»¥æœ¬åœ°æ¨¡å¼ç»§ç»­ã€‚");
            }
            
            startGame(); // TWA ready åå¯åŠ¨æ¸¸æˆ
        });
    } else {
        // é Telegram ç¯å¢ƒï¼Œç«‹å³å¯åŠ¨æ¸¸æˆ
        clearTimeout(timeoutId);
        console.warn("âŒ é Telegram ç¯å¢ƒï¼Œç«‹å³å¯åŠ¨æ¸¸æˆã€‚");
        startGame();
    }
</script>

</body>
</html>
