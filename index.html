<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PiousClick</title>

<script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js"></script>
<style>
  body { margin: 0; padding: 0; background: #222; }
</style>
</head>
<body>

<script>
window.onload = function() {
    let userId = null; // åˆå§‹åŒ–ä¸º null
    let count = parseInt(localStorage.getItem("count") || "0"); // ä» localStorage è¯»å–è®¡æ•°

    // --- 1. Phaser æ¸¸æˆæ ¸å¿ƒå‡½æ•° ---

    function preload() {
        // â—â— å†æ¬¡å¼ºè°ƒï¼šè¯·å°†æ­¤ URL æ›¿æ¢ä¸ºæ‚¨å›¾ç‰‡æ–‡ä»¶ (muyu.png) çš„å®Œæ•´ã€å¯è®¿é—®çš„ URL â—â—
        // ç¤ºä¾‹ï¼šå¦‚æœæ‚¨ä½¿ç”¨ ngrok è½¬å‘ï¼Œè¯·ç¡®ä¿è¿™é‡Œçš„ ngrok åœ°å€ä¸ fetch ä¸­çš„åœ°å€ä¸€è‡´
        this.load.image("muyu", "https://glady-nongelling-mila.ngrok-free.dev/assets/muyu.png"); 
    }

    function create() {
        const centerX = this.cameras.main.centerX;
        const centerY = this.cameras.main.centerY;

        const muyu = this.add.image(centerX, centerY, "muyu")
            .setScale(0.4)
            .setInteractive();

        const text = this.add.text(centerX, 80, "åŠŸå¾·: " + count, {
            fontSize: "32px",
            color: "#ffffff"
        }).setOrigin(0.5);

        muyu.on("pointerdown", () => {
            count++;
            localStorage.setItem("count", count);
            text.setText("åŠŸå¾·: " + count);
            
            onClicked();

            this.tweens.add({
                targets: muyu,
                scale: 0.37,
                yoyo: true,
                duration: 100
            });
        });
    }

    const config = {
        type: Phaser.AUTO,
        width: 400,
        height: 600,
        backgroundColor: "#222222",
        scene: {
            preload: preload,
            create: create
        }
    };

    function onClicked() {
        console.log(`å‘é€ç‚¹å‡»ä¿¡å·ï¼ŒUser ID: ${userId || 'N/A'}`);
        
        // æ³¨æ„ï¼šngrok-free.dev åŸŸåå¯èƒ½éšæ—¶è¿‡æœŸï¼Œè¯·ç¡®ä¿é“¾æ¥æœ‰æ•ˆ
        fetch("https://glady-nongelling-mila.ngrok-free.dev/click", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                user_id: userId
            })
        }).catch(e => {
            console.error("å‘é€ç‚¹å‡»ä¿¡å·å¤±è´¥:", e);
        });
    }

    // --- 2. TWA åˆå§‹åŒ–å’Œæ¸¸æˆå¯åŠ¨é€»è¾‘ (å…³é”®éƒ¨åˆ†) ---

    function startGame() {
        // åªæœ‰å½“ TWA é€»è¾‘å¤„ç†å®Œæ¯•åï¼Œæ‰å¯åŠ¨ Phaser æ¸¸æˆå®ä¾‹
        console.log("ğŸ® è°ƒç”¨ startGame()ï¼Œå¯åŠ¨ Phaser æ¸¸æˆ...");
        new Phaser.Game(config);
    }
    
    let isWebAppReady = false; // æ ‡å¿—ä½

    // è®¾ç½®ä¸€ä¸ªè¶…æ—¶ï¼Œé˜²æ­¢åœ¨æŸäº› TWA å®¢æˆ·ç«¯ä¸Šå¡ä½
    const timeoutDuration = 1500; // 1.5 ç§’
    const timeoutId = setTimeout(() => {
        if (!isWebAppReady) {
            console.warn("âš ï¸ Telegram WebApp æ¥å£è¶…æ—¶ (æœªè°ƒç”¨ ready)ï¼Œä»¥æœ¬åœ°æ¨¡å¼å¯åŠ¨ã€‚");
            // ã€é‡è¦ã€‘å¦‚æœè¿™é‡Œæ‰§è¡Œäº†ï¼Œè¯´æ˜ TWA æ¥å£åœ¨ 1.5 ç§’å†…æœªå‡†å¤‡å¥½ã€‚
            startGame();
        }
    }, timeoutDuration);

    if (window.Telegram && window.Telegram.WebApp) {
        // åœ¨ TWA ç¯å¢ƒä¸‹ï¼Œç­‰å¾… ready ä¿¡å·
        console.log("â³ æ£€æµ‹åˆ° Telegram WebApp å¯¹è±¡ï¼Œç­‰å¾… ready äº‹ä»¶...");
        window.Telegram.WebApp.ready(() => {
            clearTimeout(timeoutId); // æ¸…é™¤è¶…æ—¶
            isWebAppReady = true;

            // å®‰å…¨åœ°è·å– userId
            userId = window.Telegram.WebApp.initDataUnsafe?.user?.id || null;
            
            if (userId) {
                console.log(`âœ… Telegram User ID è·å–æˆåŠŸ: ${userId}`);
            } else {
                console.warn("âš ï¸ Telegram ç¯å¢ƒä¸‹æ— æ³•è·å– User ID (initDataUnsafe ä¸å®Œæ•´)ï¼Œä»¥æœ¬åœ°æ¨¡å¼ç»§ç»­ã€‚");
            }
            
            startGame(); // ready åå¯åŠ¨æ¸¸æˆ
        });
    } else {
        // é Telegram ç¯å¢ƒï¼Œç«‹å³å¯åŠ¨æ¸¸æˆ
        clearTimeout(timeoutId);
        console.warn("âŒ é Telegram ç¯å¢ƒï¼Œç«‹å³å¯åŠ¨æ¸¸æˆã€‚");
        // ã€é‡è¦ã€‘æ‚¨ä¹‹å‰å¾—åˆ°çš„ alert ä¿¡æ¯å°±æ˜¯ä»è¿™é‡Œå‘å‡ºçš„
        startGame();
    }
};
</script>

</body>
</html>
